console.log("[MindEchoS] Background script loaded");async function a(e){try{await chrome.tabs.sendMessage(e,{command:"PING"})}catch{try{await chrome.scripting.executeScript({target:{tabId:e},files:["content.js"]}),console.log(`[MindEchoS] Content script injected into tab ${e}`)}catch(t){throw console.error("[MindEchoS] Failed to inject content script:",t),t}}}async function l(){const e=await chrome.tabs.query({url:["http://*/*","https://*/*"]});for(const t of e)if(t.id)try{await chrome.scripting.executeScript({target:{tabId:t.id},files:["content.js"]})}catch{}}async function s(e,t){if(!e||e.length<=2)return;const o=e.length>=180;await chrome.storage.session.set({pendingSelection:{text:e.substring(0,5e3),url:t,needsAISummarize:!0,needsContentSummary:o}}),console.log(`[MindEchoS] Selection: ${e.length} chars, Title: AI, Content: ${o?"AI summary":"Original"}`)}async function d(e,t){if(e.id){await chrome.sidePanel.open({tabId:e.id});try{await a(e.id),await chrome.tabs.sendMessage(e.id,{command:"GET_SELECTION"})}catch(c){console.error("[MindEchoS] Failed to capture selection:",c),t&&await s(t,e.url||"")}}}chrome.runtime.onInstalled.addListener(async e=>{console.log(`[MindEchoS] Extension ${e.reason}`),chrome.contextMenus.create({id:"save-selection",title:"Save to Knowledge Cards",contexts:["selection"]}),(e.reason==="install"||e.reason==="update")&&(await l(),console.log("[MindEchoS] Content scripts injected to existing tabs"))});chrome.contextMenus.onClicked.addListener(async(e,t)=>{e.menuItemId==="save-selection"&&t&&await d(t,e.selectionText)});chrome.commands.onCommand.addListener(async(e,t)=>{e==="extract-knowledge"&&t&&await d(t)});chrome.action.onClicked.addListener(async e=>{e!=null&&e.id&&await chrome.sidePanel.open({tabId:e.id})});chrome.runtime.onMessage.addListener((e,t,c)=>{var o;if(e.type==="SELECTION_DATA"){const n=e.data.url||((o=t.tab)==null?void 0:o.url)||"";return s(e.data.text,n),!1}return e.command==="GET_ACTIVE_TAB_SELECTION"?(chrome.tabs.query({active:!0,currentWindow:!0},async n=>{var i;if((i=n[0])!=null&&i.id)try{await a(n[0].id);const r=await chrome.tabs.sendMessage(n[0].id,{command:"GET_SELECTION_FOR_MODAL"});c(r)}catch{c({success:!1,error:"Unable to get selection"})}}),!0):e.command==="EXTRACT_CURRENT_WEBPAGE"?(chrome.tabs.query({active:!0,currentWindow:!0},async n=>{var i;if((i=n[0])!=null&&i.id)try{await a(n[0].id);const r=await chrome.tabs.sendMessage(n[0].id,{command:"EXTRACT_WEBPAGE"});c(r)}catch{c({success:!1,error:"Unable to extract webpage"})}}),!0):!1});
